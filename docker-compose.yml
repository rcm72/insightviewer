services:
  neo4j:
    image: neo4j:5.25-community
    container_name: neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      # You can export NEO4J_PASSWORD in your shell or define it in a .env file
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD}"
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
      # Memory configuration (adjust based on your system RAM)
      NEO4J_server_memory_heap_initial__size: "512m"
      NEO4J_server_memory_heap_max__size: "1G"
      NEO4J_server_memory_pagecache_size: "512m"
    deploy:
      resources:
        limits:
          memory: 2G    # Docker memory limit
        reservations:
          memory: 512M  # Minimum guaranteed memory
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
      - neo4j_import:/var/lib/neo4j/import
    networks:
      - appnet

  insightviewer:
    container_name: insightviewer
    restart: unless-stopped
    build:
      context: ./source/InsightViewer  # Specify the build context
      dockerfile: Dockerfile           # Ensure this Dockerfile exists
    ports:
      - "5001:5000"   # host:container
    volumes:
      - ./source/InsightViewer/app/static/editor_files:/app/app/static/editor_files
      - ./source/InsightViewer/app/static/images:/app/app/static/images
      - ./source/InsightViewer:/app
      - ./source/InsightViewer/app/rag/chroma_db:/app/app/chroma_db
    environment:
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}  # Ensure this is defined in your .env file
      - APP_SECRET_KEY=${APP_SECRET_KEY}  # Ensure this is defined in your .env file
      - DEBUG_MODE=${DEBUG_MODE}          # Ensure this is defined in your .env file
    env_file:
      - ./config.env                      # Ensure this file exists and is correctly formatted
    depends_on:
      - neo4j
      - quiz-api
    networks:
      - appnet

  quiz-api:
    build:
      context: .
      dockerfile: Dockerfile.quiz
    container_name: quiz-api
    volumes:
      - ./source/InsightViewer:/app
      - ./source/InsightViewer/app/rag/chroma_db:/app/app/chroma_db
    environment:
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - APP_SECRET_KEY=${APP_SECRET_KEY}
    ports:
      - "8001:8001"   # da lahko testira≈° tudi izven Dockera
    networks:
      - appnet

  rag-chat-api:
    env_file:
      - config.env
    build:
      context: .
      dockerfile: Dockerfile.quiz
    container_name: rag-chat-api
    volumes:
      - ./source/InsightViewer:/app
      #- ./config.ini:/app/config.ini:ro
      - ./source/InsightViewer/config.ini:/app/config.ini:ro
    working_dir: /app
    entrypoint: ["uvicorn", "app.scripts.rag.rag_chat_api:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8002:8000"
    depends_on:
      - neo4j
    networks:
      - appnet

  rag-chat-api-v2:
    env_file:
      - config.env  
    build:
      context: .
      dockerfile: Dockerfile.quiz
    container_name: rag-chat-api-v2
    volumes:
      - ./source/InsightViewer:/app
      #- ./config.ini:/app/config.ini:ro                  
      - ./source/InsightViewer/config.ini:/app/config.ini:ro
    working_dir: /app
    entrypoint: ["uvicorn", "app.scripts.rag.rag_chat_api_v2:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8003:8000"
    depends_on:
      - neo4j
    networks:
      - appnet  

  rag-chat-api-v3:
    env_file:
      - config.env
    build:
      context: .
      dockerfile: Dockerfile.quiz
    container_name: rag-chat-api-v3
    volumes:
      - ./source/InsightViewer:/app
      #- ./config.ini:/app/config.ini:ro
      - ./source/InsightViewer/config.ini:/app/config.ini:ro
    working_dir: /app
    entrypoint: ["uvicorn", "app.scripts.rag.rag_chat_api_v3:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8004:8000"          # nov host port
    environment:
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - NEO4J_URI=${NEO4J_URI}
    depends_on:
      - neo4j
    networks:
      - appnet          

  open-webui:
    env_file:
      - config.env
    image: ghcr.io/open-webui/open-webui:latest
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://192.168.1.36:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - openwebui_data:/app/backend/data
    networks:
      - appnet

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  neo4j_import:
  openwebui_data:

networks:
  appnet:
    driver: bridge


