<!--
SPDX-License-Identifier: AGPL-3.0-or-later
Copyright (c) 2025 Robert ƒåmrlec
-->
<div id="akadaQuiz" class="floating-dialog" style="display:none; width:820px; max-width:95vw;"></div>


<style>
    :root{
      --bg:#aad691;--panel:#a2d56f;--muted:#8a93a6;--text:#e7ecf7;--accent:#9b7cf6;--accent2:#2dd4bf;--warn:#f59e0b;--danger:#ef4444;--ok:#10b981;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      --radius:18px
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0c0c12,#0d1117 30%,#0f141b);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,Helvetica,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    .title{font-size:clamp(20px,3vw,32px);font-weight:800;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:14px}
    .card{background:var(--panel);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.04)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .story{min-height:180px}
    .choices{display:grid;gap:10px;margin-top:10px}
    button.choice{appearance:none;border:0;border-radius:14px;padding:12px 14px;background:#212636;color:var(--text);text-align:left;cursor:pointer;box-shadow:var(--shadow);transition:.15s transform,.15s background,.15s border,.15s opacity}
    button.choice:hover{transform:translateY(-1px);background:#263044}
    button.choice small{display:block;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .tag{padding:6px 10px;border-radius:999px;background:#212636;color:#c9d5f2;border:1px solid rgba(255,255,255,.06);font-size:12px}
    .stats{display:grid;gap:10px}
    .stat{background:#121520;border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:10px}
    .stat h4{margin:0 0 6px 0;font-size:12px;letter-spacing:.5px;color:#b8c1d9;text-transform:uppercase}
    .bar{height:10px;background:#0c0f18;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:50%;transition:width .35s ease}
    .fill.warn{background:linear-gradient(90deg,var(--warn),#f87171)}
    .fill.good{background:linear-gradient(90deg,#34d399,#60a5fa)}
    .log{max-height:260px;overflow:auto;scrollbar-width:thin}
    .log p{margin:.5em 0;color:#b9c2d8}
    .muted{color:var(--muted)}
    .foot{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.1);background:#1b2030;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#232a3e}
    .pill{border-radius:999px;padding:6px 10px;background:#1b2030;border:1px solid rgba(255,255,255,.1);font-size:12px}
    .ending{font-size:18px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#a0a8bd}
    .scoreline{display:flex;align-items:center;gap:6px}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#1b2030}
    details.note{margin-top:8px}
    a{color:#a5b4fc}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- title moved to parent; render here if provided -->
      <div id="quizTitleContainer" aria-hidden="false"></div>
      <div class="foot">
        <span id="era" class="pill">~ 24.‚Äì21. stol. pr. Kr.</span>
        <button class="btn" id="save">Shrani</button>
        <button class="btn" id="load">Nalo≈æi</button>
        <button class="btn" id="reset">Zaƒçni znova</button>
      </div>
    </header>
    <script>
      // ...existing code...
      // render title/subtitle from parent-provided AKAD_META (if present)
      (function(){
        function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
        try{
          const meta = (window.parent && window.parent.AKAD_META) ? window.parent.AKAD_META : null;
          if(meta){
            const container = document.getElementById('quizTitleContainer');
            if(container){
              container.innerHTML = `<div><div class="title">${esc(meta.title)}</div><div class="subtitle">${esc(meta.subtitle)}</div></div>`;
            }
          }
        }catch(e){}
      })();
      // ...existing code...
    </script>    

    <div class="grid" style="margin-top:16px">
      <section class="card story">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="tag">Trenutek: <strong id="levelLabel">Prolog</strong></div>
          <div class="muted mono" id="turns"></div>
        </div>
        <h2 id="sceneTitle" style="margin:10px 0 8px 0">Dobrodo≈°el v Akadu</h2>
        <p id="sceneText" class="muted">Pi≈°e se 24. stoletje pr. Kr. Sumerci vladajo mesosopotamskim mestnim dr≈æavicam. V ozadju se dviga Sargon Akadski. Ti bo≈° vodil njegove odloƒçitve.</p>
        <div class="choices" id="choices"></div>
      </section>

      <aside class="card">
        <h3 style="margin:0 0 8px 0">Kazalci oblasti</h3>
        <div class="stats">
          <div class="stat"><h4>Voja≈°ka moƒç</h4><div class="bar"><div class="fill" id="stat-mil"></div></div></div>
          <div class="stat"><h4>Blagajna</h4><div class="bar"><div class="fill" id="stat-tre"></div></div></div>
          <div class="stat"><h4>≈Ωito in preskrba</h4><div class="bar"><div class="fill" id="stat-food"></div></div></div>
          <div class="stat"><h4>Ugled & legitimnost</h4><div class="bar"><div class="fill" id="stat-leg"></div></div></div>
          <div class="stat"><h4>Dru≈æbena stabilnost</h4><div class="bar"><div class="fill" id="stat-stab"></div></div></div>
          <div class="stat"><h4>Zgodovinska toƒçnost</h4><div class="bar"><div class="fill" id="stat-hist"></div></div></div>
          <div class="scoreline"><strong id="histScore">Toƒçnost: 0 / 0</strong><span class="badge" id="histGrade">‚Äì</span></div>
        </div>
        <div class="card" style="margin-top:14px">
          <strong>Kronika</strong>
          <div class="log" id="log"></div>
        </div>
        <details class="note">
          <summary><strong>Kako ocenjujem toƒçnost?</strong></summary>
          <p class="muted">Vsaka izbira dobi toƒçke <em>zgodovinske toƒçnosti</em> (‚àí1, 0, +1) glede na to, kar vemo iz zgodovine Akada: Sargonov voja≈°ki vzpon in trgovina; davki in garnizije; Naram‚ÄëSinova bo≈æanska ikonografija; su≈°a v 22. stol. pr. Kr.; ter zakonnik Ur‚ÄëNamuja v 21. stol. pr. Kr.</p>
        </details>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <details>
        <summary><strong>Navodila</strong></summary>
        <p>Vsaka odloƒçitev spremeni pet kazalcev: <em>Voja≈°ka moƒç</em>, <em>Blagajna</em>, <em>≈Ωito</em>, <em>Ugled</em> in <em>Stabilnost</em>. ƒåe kateri koli pade na 0, se tvoja vladavina konƒça. Zdaj se poleg tega bele≈æi ≈°e <em>zgodovinska toƒçnost</em> tvojih odloƒçitev.</p>
        <p>Igra temelji na resniƒçnih motivih: Sargonov vzpon, trgovina in davki, Naram‚ÄëSinovo bo≈æanstvo, su≈°a v 22. stol. pr. Kr. ter zakonnik Ur‚ÄëNamuja iz Ura (21. stol. pr. Kr.).</p>
      </details>
    </section>

    <footer class="muted" style="text-align:center;margin:20px 0 30px 0">¬© Akad ‚Äî izobra≈æevalna besedilna igra. Nasvet: ciljaj na ravnote≈æje <em>in</em> toƒçne odloƒçitve!</footer>
  </div>

  <script>
  /*** MODEL STANJA ***/
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const S = {
    mil:60, tre:50, food:50, leg:55, stab:55,
    hist:0, histMax:0,
    level:0, turn:0, over:false
  };





  /*** POGON ***/

  // Prefer parent-provided levels (same-origin). Fallback to window.LEVELS or empty.
  let LEVELS;
  try {
    LEVELS = (window.parent && window.parent.AKAD_LEVELS) ? window.parent.AKAD_LEVELS : (window.LEVELS || []);
  } catch (e) {
    LEVELS = window.LEVELS || [];
  }

  // --- add this: prefer parent-provided ENDINGS, safe fallback ---
  let ENDINGS;
  try {
    ENDINGS = (window.parent && window.parent.AKAD_ENDINGS) ? window.parent.AKAD_ENDINGS : (window.ENDINGS || []);
  } catch (e) {
    ENDINGS = window.ENDINGS || [];
  }
  if (!Array.isArray(ENDINGS) || ENDINGS.length === 0) {
    console.warn('No ENDINGS supplied from parent ‚Äî using empty list (ensure parent sets window.AKAD_ENDINGS before iframe loads)');
    ENDINGS = ENDINGS || [];
  }

  // Defensive normalization: ensure each choice has an 'h' (history score) and 'd' object
  LEVELS.forEach((L, li) => {
    if (!L || !Array.isArray(L.choices)) return;
    L.choices.forEach((c, ci) => {
      if (typeof c.h === 'undefined') {
        console.warn(`LEVELS[${li}].choices[${ci}].h missing ‚Äî treating as 0`);
        c.h = 0;
      }
      if (typeof c.d !== 'object' || c.d === null) c.d = {};
    });
  });

  const ui={
    mil:document.getElementById('stat-mil'),
    tre:document.getElementById('stat-tre'),
    food:document.getElementById('stat-food'),
    leg:document.getElementById('stat-leg'),
    stab:document.getElementById('stat-stab'),
    hist:document.getElementById('stat-hist'),
    title:document.getElementById('sceneTitle'),
    text:document.getElementById('sceneText'),
    choices:document.getElementById('choices'),
    log:document.getElementById('log'),
    levelLabel:document.getElementById('levelLabel'),
    turns:document.getElementById('turns'),
    era:document.getElementById('era'),
    histScore:document.getElementById('histScore'),
    histGrade:document.getElementById('histGrade')
  };

  function renderBars(){
    const set=(el,val)=>{
      el.style.width=clamp(val,0,100)+"%";
      el.classList.toggle('warn', val<25);
      el.classList.toggle('good', val>70);
    };
    set(ui.mil,S.mil); set(ui.tre,S.tre); set(ui.food,S.food); set(ui.leg,S.leg); set(ui.stab,S.stab);
    // zgodovinska toƒçnost kot odstotek pravilnih odloƒçitev
    const ratio = S.histMax ? Math.round(((S.hist + S.histMax) / (2*S.histMax)) * 100) : 0; // preslikava ‚àí1..+1 v 0..100
    set(ui.hist, ratio);
    ui.histScore.textContent = `Toƒçnost: ${S.histMax? (S.hist>0?'+':'')+S.hist : 0} / ${S.histMax}`;
    ui.histGrade.textContent = gradeFromRatio(ratio);
  }

  function gradeFromRatio(r){
    return r;
  }

  function logMsg(msg){
    const p=document.createElement('p'); p.innerHTML=msg; ui.log.prepend(p);
  }

  function apply(delta, label, histDelta, why){
    for(const k of ['mil','tre','food','leg','stab']){
      S[k]=clamp(S[k]+(delta[k]||0),0,100);
    }
    // zgodovinska toƒçnost
    S.hist += (histDelta||0); S.histMax += 1;

    S.turn++; renderBars(); ui.turns.textContent = `Poteze: ${S.turn}`;
    checkLoss();
    if(label){
      const ico = histDelta>0?'‚úì':(histDelta<0?'‚úó':'‚Ä¢');
      const tone = histDelta>0?'<span style="color:#10b981">‚úì toƒçno</span>':(histDelta<0?'<span style="color:#ef4444">‚úó netoƒçno</span>':'<span class="muted">‚Ä¢ delno / nevtralno</span>');
      logMsg(`${label} ‚Äî ${tone}${why?` <span class="muted">(${why})</span>`:''}`);
    }
  }

  function scene(idx){
    if(idx>=LEVELS.length){ return ending(); }
    S.level=idx;
    const L=LEVELS[idx];
    ui.levelLabel.textContent=L.label;
    ui.title.textContent=L.title;
    ui.text.textContent=L.text;
    ui.choices.innerHTML='';
    L.choices.forEach((c,i)=>{
      const b=document.createElement('button'); b.className='choice';
      b.innerHTML=`<strong>${c.label}</strong><small>${c.hint}</small>`;
      b.addEventListener('click',()=>{
        apply(c.d, `${L.label}: ${c.label}`, c.h||0, c.why);
        scene(idx+1);
      });
      ui.choices.appendChild(b);
    });
    const eras=["~ 24. stol. pr. Kr.","~ 24.‚Äì23. stol.","~ 23. stol.","~ 23.‚Äì22. stol.","~ 22. stol.","~ 21. stol. pr. Kr."];
    ui.era.textContent = eras[clamp(idx,0,eras.length-1)];
  }

  function checkLoss(){
    if(S.mil<=0||S.tre<=0||S.food<=0||S.leg<=0||S.stab<=0){
      S.over=true; gameOver("Propad: eden od kazalcev je padel na niƒç.");
    }
  }

  function ending(){
    const e = ENDINGS.find(e=>e.test(S));
    const ratio = S.histMax ? Math.round(((S.hist + S.histMax) / (2*S.histMax)) * 100) : 0;
    const block=document.createElement('div');
    block.className='ending';
    block.innerHTML=`<h2>KONEC ‚Äì ${e.title}</h2><p>${e.text}</p>
    <p class="muted">Povzetek: Vojska ${S.mil} ¬∑ Blagajna ${S.tre} ¬∑ ≈Ωito ${S.food} ¬∑ Ugled ${S.leg} ¬∑ Stabilnost ${S.stab}</p>
    <p><strong>Zgodovinsk toƒçnost :</strong> ${S.hist>0?'+':''}${S.hist} / ${S.histMax} (${ratio}%, ocena ${gradeFromRatio(ratio)})</p>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="restart()">Igraj znova</button>
      <button class="btn" onclick="shareState()">Deli izid</button>
    </div>`;
    ui.choices.innerHTML='';
    ui.text.innerHTML='';
    ui.title.textContent='Epilog1 Akada';
    ui.choices.appendChild(block);
    logMsg(`Zakljuƒçek: ${e.title}`);
  }

  function gameOver(reason){
    ui.choices.innerHTML='';
    const ratio = S.histMax ? Math.round(((S.hist + S.histMax) / (2*S.histMax)) * 100) : 0;
    const b=document.createElement('div');
    b.className='ending';
    b.innerHTML=`<h2>${reason}</h2><p>Tvoja vladavina se tu konƒça. Poskusi drugaƒçno ravnote≈æje med davki, ≈æitom in ugledom.</p>
    <p><strong>Zgodovinska toƒçnost do zdaj:</strong> ${S.hist>0?'+':''}${S.hist} / ${S.histMax} (${ratio}%, ocena ${gradeFromRatio(ratio)})</p>
    <div class="row" style="margin-top:10px"><button class="btn" onclick="restart()">Poskusi znova</button></div>`;
    ui.choices.appendChild(b);
  }

  function restart(){
    Object.assign(S,{mil:60,tre:50,food:50,leg:55,stab:55,hist:0,histMax:0,level:0,turn:0,over:false});
    ui.log.innerHTML='';
    renderBars();
    scene(0);
  }

  function save(){
    localStorage.setItem('akad-save', JSON.stringify(S));
    logMsg('‚úî Shranjeno.');
  }
  function load(){
    const raw=localStorage.getItem('akad-save');
    if(!raw){ logMsg('Ni shrambe za nalo≈æiti.'); return; }
    const obj=JSON.parse(raw); Object.assign(S,obj);
    renderBars();
    ui.turns.textContent = `Poteze: ${S.turn}`;
    scene(S.level);
    logMsg('‚éò Nalo≈æeno.');
  }
  function shareState(){
    const data=btoa(JSON.stringify(S));
    const url=new URL(location.href); url.hash=data;
    navigator.clipboard.writeText(url.toString()).then(()=>logMsg('üîó Povezava do izida kopirana v odlo≈æi≈°ƒçe.'));
  }
  function tryHashLoad(){
    if(location.hash.length>1){
      try{ const obj=JSON.parse(atob(location.hash.slice(1))); Object.assign(S,obj); }catch(e){}
    }
  }

  document.getElementById('save').onclick=save;
  document.getElementById('load').onclick=load;
  document.getElementById('reset').onclick=restart;

  // render title/subtitle from parent-provided AKAD_META (if present)
  (function(){
    function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    try{
      const meta = (window.parent && window.parent.AKAD_META) ? window.parent.AKAD_META : null;
      if(meta){
        const container = document.getElementById('quizTitleContainer');
        if(container){
          container.innerHTML = `<div><div class="title">${esc(meta.title)}</div><div class="subtitle">${esc(meta.subtitle)}</div></div>`;
        }
      }
    }catch(e){}
  })();

  tryHashLoad();
  renderBars();
  scene(S.level||0);
  </script>
