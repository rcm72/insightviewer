<!--
SPDX-License-Identifier: AGPL-3.0-or-later
Copyright (c) 2025 Robert Čmrlec
-->
<div id="choose-template-dialog" class="floating-dialog" style="display:none; width:820px; max-width:95vw;">
  <div class="dialog-header">
    <span>Choose template</span>
    <button onclick="closeChooseTemplateDialog()">X</button>
  </div>

  <div style="padding:12px; max-height:60vh; overflow:auto;">
    <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
      <input id="tmpl-search" type="search" placeholder="Filter templates..." style="flex:1; padding:6px;">
      <button type="button" onclick="fetchTemplates()">Refresh</button>
    </div>

    <table id="tmpl-table" style="width:100%; border-collapse:collapse; font-size:0.95rem;">
      <thead>
        <tr style="text-align:left; border-bottom:1px solid #e6e6e6;">
          <th style="padding:6px 8px; width:28%;">Name</th>
          <th style="padding:6px 8px; width:28%;">Filename</th>
          <th style="padding:6px 8px;">Description</th>
          <th style="padding:6px 8px; width:90px;">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="tmpl-status" style="color:#666; margin-top:8px; font-size:0.9rem;"></div>
  </div>

  <div style="display:flex; gap:8px; justify-content:flex-end; padding:12px; border-top:1px solid #eee;">
    <button type="button" onclick="closeChooseTemplateDialog()">Cancel</button>
  </div>
</div>

<script>
/* Dialog control + simple client for template endpoints
   Backend endpoints expected (adjust if your Flask routes differ):
   - GET  /api/templates                 -> returns JSON array of templates [{name, filename, description}, ...]
   - GET  /api/template?filename=NAME   -> returns raw HTML/text for selected template
*/

function openChooseTemplateDialog() {
  const dlg = document.getElementById('choose-template-dialog');
  if (!dlg) return;
  dlg.style.display = 'block';
  fetchTemplates();
  const search = document.getElementById('tmpl-search');
  search.value = '';
  search.focus();
  search.oninput = () => filterTemplates(search.value);
}

function closeChooseTemplateDialog() {
  const dlg = document.getElementById('choose-template-dialog');
  if (!dlg) return;
  dlg.style.display = 'none';
  // clear table to avoid stale state
  const tbody = document.querySelector('#tmpl-table tbody');
  if (tbody) tbody.innerHTML = '';
  const status = document.getElementById('tmpl-status'); if (status) status.textContent = '';
}

async function fetchTemplates() {
  const status = document.getElementById('tmpl-status');
  status.textContent = 'Loading…';
  try {
    const res = await fetch('/api/templates', { cache: 'no-store' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.templates || []);
    renderTemplateList(list);
    status.textContent = `Loaded ${list.length} templates.`;
  } catch (err) {
    console.error('fetchTemplates error', err);
    status.textContent = 'Failed to load templates — check server. See console for details.';
  }
}

function renderTemplateList(list) {
  const tbody = document.querySelector('#tmpl-table tbody');
  tbody.innerHTML = '';
  list.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${escapeHtml(item.name || '')}</td>
      <td style="padding:8px; border-bottom:1px solid #f0f0f0; color:#444; font-family:monospace;">${escapeHtml(item.filename || '')}</td>
      <td style="padding:8px; border-bottom:1px solid #f0f0f0; color:#555;">${escapeHtml(item.description || '')}</td>
      <td style="padding:8px; border-bottom:1px solid #f0f0f0;">
        <button type="button" data-filename="${escapeHtml(item.filename || '')}" class="tmpl-load-btn">Load</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // wire buttons
  tbody.querySelectorAll('.tmpl-load-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const fn = btn.dataset.filename;
      if (!fn) return;
      loadTemplateIntoEditor(fn);
    });
  });
}

function filterTemplates(q) {
  q = (q || '').toLowerCase().trim();
  document.querySelectorAll('#tmpl-table tbody tr').forEach(tr => {
    const text = tr.textContent.toLowerCase();
    tr.style.display = text.includes(q) ? '' : 'none';
  });
}

async function loadTemplateIntoEditor(filename) {
  const status = document.getElementById('tmpl-status');
  status.textContent = `Loading ${filename}…`;
  try {
    const res = await fetch('/api/template?filename=' + encodeURIComponent(filename), { cache: 'no-store' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const html = await res.text();

    // Preferred helper if available
    if (typeof window.setHtmlEditorContent === 'function') {
      window.setHtmlEditorContent(html);
    } else {
      // 1) Hidden textarea used as fallback (triggers any input listeners)
      const ta = document.getElementById('html-editor-textarea');
      if (ta) {
        ta.value = html;
        ta.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // 2) Common global instances / adapters
      const candidates = [
        window._htmlEditorInstance,    // possible shape: { view, adapter } or CodeMirror instance
        window.htmlEditorInstance,
        window._htmlEditorAdapter,
        window._htmlEditor,            // older apps
        window._cm, window._cm5, window.cmInstance
      ];
      for (const c of candidates) {
        if (!c) continue;
        // direct CodeMirror-like
        if (typeof c.setValue === 'function') {
          try { c.setValue(html); break; } catch(e){/* ignore */ }
        }
        // adapter style
        if (c.adapter && typeof c.adapter.setValue === 'function') {
          try { c.adapter.setValue(html); break; } catch(e){/* ignore */ }
        }
        // CM6 adapter stored directly
        if (typeof c === 'object' && typeof c.setValue === 'undefined' && c.view && c.adapter && typeof c.adapter.setValue === 'function') {
          try { c.adapter.setValue(html); break; } catch(e){/* ignore */ }
        }
      }

      // 3) Try to find a CodeMirror instance in DOM
      try {
        const cmDom = document.querySelector('#html-editor-container .CodeMirror');
        if (cmDom && cmDom.CodeMirror && typeof cmDom.CodeMirror.setValue === 'function') {
          cmDom.CodeMirror.setValue(html);
        }
      } catch(e){/* ignore */ }
    }

    status.textContent = `Template ${filename} loaded.`;
    setTimeout(closeChooseTemplateDialog, 300);
  } catch (err) {
    console.error('loadTemplateIntoEditor error', err);
    status.textContent = 'Failed to load template — check server or filename.';
  }
}

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
