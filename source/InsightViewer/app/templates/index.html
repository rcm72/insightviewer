<!--
SPDX-License-Identifier: AGPL-3.0-or-later
Copyright (c) 2025 Robert Čmrlec
-->
<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='vis-network.min.js') }}"></script>
    <script type="module">
        import {EditorState, Compartment} from "https://esm.sh/@codemirror/state@6";
        import {EditorView, highlightActiveLine, drawSelection} from "https://esm.sh/@codemirror/view@6";
        import {lineNumbers} from "https://esm.sh/@codemirror/gutter@6";

        // minimal adapter so existing CM5-style calls (getValue/setValue/getDoc) still work
        function makeAdapter(view) {
          return {
            getValue() { return view.state.doc.toString(); },
            setValue(v) {
              view.dispatch({changes: {from: 0, to: view.state.doc.length, insert: v}});
            },
            getDoc() {
              return {
                listSelections: () => view.state.selection.ranges.map(r => ({ anchor: r.anchor, head: r.head })),
                getCursor: () => view.state.selection.main.head,
                replaceRange: (text, pos) => {
                  const p = (typeof pos === "number") ? pos : (view.state.doc.line(pos.line + 1).from + pos.ch);
                  view.dispatch({changes: {from: p, to: p, insert: text}});
                }
              };
            },
            focus() { view.focus(); },
            setSize() {}
          };
        }

        // simple factory used by indexScript.js
        window.createCM6HtmlEditor = function(parent, initialValue = "", {dark = true} = {}) {
          const themeSlot = new Compartment();

          const state = EditorState.create({
            doc: initialValue,
            extensions: [
              lineNumbers(),          // <-- line numbers enabled here
              highlightActiveLine(),
              drawSelection(),
              themeSlot.of([]),
            ]
          });

          const view = new EditorView({state, parent});
          return { view, adapter: makeAdapter(view) };
        };

        console.log("createCM6HtmlEditor defined on window:", typeof window.createCM6HtmlEditor);
    </script>
      
    <!-- minimal, robust CodeMirror 5 integration (provides line numbers) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <!-- modes (HTML mixed gives HTML+CSS+JS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <!-- Use CodeMirror 5 with addons & a theme for syntax highlighting and simple autocomplete -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <!-- addons: auto-close, match brackets, active line, and simple hinting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/html-hint.min.js"></script>

    <script>
    /*
      Expose createCM6HtmlEditor for compatibility with your app.
      Internally uses CodeMirror 5 but adapter implements getValue/setValue/getDoc used by your code.
    */
    window.createCM6HtmlEditor = window.createCM6HtmlEditor || function(parent, initialValue = "", {dark = true} = {}) {
      // create container
      const container = document.createElement('div');
      container.style.height = '100%';
      container.style.width = '100%';
      parent.appendChild(container);

      // instantiate CodeMirror 5
      const cm = CodeMirror(container, {
        value: initialValue || "",
        mode: 'htmlmixed',
        lineNumbers: true,
        lineWrapping: true,
        theme: dark ? 'monokai' : 'default',
        autoCloseBrackets: true,
        matchBrackets: true,
        styleActiveLine: true,
        extraKeys: {
          "Ctrl-S": function(cm){ if (window.saveHtmlFromEditor) window.saveHtmlFromEditor(); },
          "Ctrl-Space": function(cm){ cm.showHint({hint: CodeMirror.hint.html, completeSingle: false}); }
        },
        hintOptions: { completeSingle: false }
      });

      cm.setSize("100%", "100%");      

      // Auto-trigger hints while typing (lightweight)
      cm.on("inputRead", function(cmInstance, change) {
        // avoid triggering on non-user changes
        if (!change || change.origin === "setValue") return;
        const ch = (change.text && change.text[0]) || "";
        if (/[<\w\/]/.test(ch)) {
          // slight debounce to let the editor state update
          setTimeout(() => {
            cmInstance.showHint({ hint: CodeMirror.hint.html, completeSingle: false });
          }, 50);
        }
      });

      // adapter similar to CM6 adapter used elsewhere
      const adapter = {
        getValue() { return cm.getValue(); },
        setValue(v) { cm.setValue(v); },
        getDoc() {
          const doc = cm.getDoc();
          return {
            listSelections: () => [ doc.listSelections ? doc.listSelections() : [] ],
            getCursor: () => doc.getCursor ? doc.getCursor() : {line:0,ch:0},
            replaceRange: (text, pos) => {
              if (typeof pos === 'number') {
                const from = cm.posFromIndex(pos);
                cm.replaceRange(text, from);
              } else if (pos && typeof pos.line === 'number') {
                cm.replaceRange(text, pos);
              } else {
                cm.replaceRange(text);
              }
            }
          };
        },
        focus() { cm.focus(); },
        setSize(w, h) { if (w) container.style.width = w; if (h) container.style.height = h; cm.refresh(); }
      };

      // return shape expected by your code (view may be null for CM5)
      return { view: cm, adapter };
    };

    console.log('createCM6HtmlEditor -> CodeMirror5 (highlighting) installed:', typeof window.createCM6HtmlEditor);
    </script>
</head>
<body>    
    <div class="menu-container" id="menu">
        <ul>
            <li>Graphing
                <ul>
                    <li onclick="openCypherDialog()">Explore with cypher</li>   

                    <li >Custom graphs
                        <ul>
                            <li onclick="OpenCreateCustomGraph()">Create</li>  
                            <li onclick="openLoadCustomGraphDialog()">Load</li>                                              
                            <li onclick="AddExistingNodes()">Add existing nodes</li>            
                        </ul>
                    </li>                 
                    <li>Define Meta Model
                        <ul>
                            <li onclick="openCreateNodeTypeDialog()">Create Node Type</li>
                            <li onclick="openCreateEdgeTypeDialog()">Create Edge Type</li>
                        </ul>
                    </li>                    
                </ul>        
            </li>
            <li>Utilities
                <ul>
                    <li onclick="openNodePropertiesDialog()">Show Node Properties</li>
                    <li id="physicsToggle"  onclick="changePhysics()">Disable physics</li>
                </ul>
            </li>                 
        </ul>
    </div>

    <!-- Resizable Handle -->
    <div id="drag-handle"></div>

    <!-- Graph Container -->
    <div class="content" id="content">
        <div id="network-container"></div>
    </div>

    <!-- Floating Cypher Query Dialog -->

    <div id="CreateCustomGraph" class="floating-dialog" style="display: none;">
        <div class="dialog-header">
            <span>Create custom Graph</span>
            <button onclick="closeCreateGraphDialog()">X</button>
        </div>
        <div>
            <h4>Custom graph name</h4>
            <input type="text" id="CustomGraphName" name="CustomGraphName"  placeholder="Enter custom graph name">
            <button onclick="createCustomGraph(document.getElementById('CustomGraphName').value)">Create custom graph</button>
        </div>
        <hr>
    </div>

    <!-- Load Custom Graph dialog (moved from menu) -->
    <div id="LoadCustomGraph" class="floating-dialog" style="display: none; width: 360px;">
        <div class="dialog-header">
            <span>Load Custom Graph</span>
            <button onclick="closeLoadCustomGraphDialog()">X</button>
        </div>
        <div style="padding:8px;">
            <label for="customLoadGraphSelect">Graph name</label>
            <select id="customLoadGraphSelect" style="width:100%; margin-top:6px;">
              <option value="">Loading...</option>
            </select>
            <div id="customLoadGraphMsg" style="color:#777; margin-top:6px; display:none;"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                <button onclick="closeLoadCustomGraphDialog()">Cancel</button>
                <button id="loadCustomGraphBtn" onclick="loadCustomGraph(document.getElementById('customLoadGraphSelect').value)">Load</button>
            </div>
        </div>
    </div>
    
    <script>
      // Dialog helpers for Load Custom Graph - replaces previous simple open/close
      async function openLoadCustomGraphDialog(){
        const d = document.getElementById('LoadCustomGraph');
        const sel = document.getElementById('customLoadGraphSelect');
        const msg = document.getElementById('customLoadGraphMsg');
        const loadBtn = document.getElementById('loadCustomGraphBtn');
        if(!d || !sel) return;
        // show dialog immediately
        d.style.display = 'block';
        sel.innerHTML = '<option value="">Loading...</option>';
        msg.style.display = 'none';
        loadBtn.disabled = true;

        try {
          // adjust endpoint if your blueprint uses different prefix (e.g. /getCustomGraphs)
          const res = await fetch('/nodes/getCustomGraphs');
          const text = await res.text();
          let data;
          try { data = JSON.parse(text); } catch(e) { data = text; }
          
          // Accept two formats:
          // 1) { success: true, graphs: [ "name1", "name2" ] }
          // 2) ["name1","name2"]
          let list = [];
          if (Array.isArray(data)) list = data;
          else if (data && Array.isArray(data.graphs)) list = data.graphs;
          else if (data && Array.isArray(data.items)) list = data.items;
          
          sel.innerHTML = '';
          if (list.length === 0) {
            sel.innerHTML = '<option value="">(no saved graphs)</option>';
            msg.textContent = 'No saved custom graphs found.';
            msg.style.display = 'block';
            loadBtn.disabled = true;
          } else {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = '-- select graph --';
            sel.appendChild(placeholder);
            list.forEach(g => {
              const opt = document.createElement('option');
              // support objects with name property
              const name = (typeof g === 'string') ? g : (g.name || g.title || g.label || JSON.stringify(g));
              opt.value = name;
              opt.textContent = name;
              sel.appendChild(opt);
            });
            loadBtn.disabled = false;
            // focus/select first real option
            setTimeout(()=> {
              sel.focus();
              if (sel.options.length>1) sel.selectedIndex = 1;
            }, 50);
          }
        } catch (err) {
          console.error('Failed to load custom graphs', err);
          sel.innerHTML = '<option value="">(load failed)</option>';
          msg.textContent = 'Failed to load list. See console for details.';
          msg.style.display = 'block';
          loadBtn.disabled = true;
        }
      }
      function closeLoadCustomGraphDialog(){
        const d = document.getElementById('LoadCustomGraph');
        if(!d) return;
        d.style.display = 'none';
      }
    </script>

    <div id="cypher-dialog" class="floating-dialog" style="display:none; width:760px;">
        <div class="dialog-header">
            <span>Enter Cypher Query</span>
            <button onclick="closeCypherDialog()">X</button>
        </div>
        <textarea id="cypher-input" placeholder="" oninput="resizeDialog()">
MATCH (s)
WHERE NOT ANY(l IN labels(s) WHERE toLower(l) CONTAINS 'custom') and NOT 'NodeType' IN labels(s)
OPTIONAL MATCH (s)-[r]-(t)
RETURN s, r, t            
        </textarea>
        <div>
            <input type="checkbox" id="clear-graph-checkbox">
            <label for="clear-graph-checkbox">Clear existing graph</label>
        </div>
        <button onclick="runCypherQuery()">Run</button>
    </div>

    <!-- Floating Node Dialog -->
    <div id="floating-node-dialog" class="floating-dialog">
        <div class="dialog-header" id="dialog-header">Select Node Type</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="node-type-selector">Node Type:</label>
            <select id="node-type-selector" style="width: 70%;"></select>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="node-name">Node Name:</label>
            <input type="text" id="node-name" placeholder="Enter node name">
        </div>

        <!-- Image URL field: appears only when chosen node type uses an image shape -->
        <div id="node-image-field" style="display: none; margin-top:8px;">
            <label for="node-image-url">Image URL:</label>
            <input type="text" id="node-image-url" placeholder="Enter image URL or path (e.g. /static/images/deska.jpg)" style="width: 80%;">
            <div id="node-image-preview" style="margin-top:6px; display:none;">
                <img id="node-image-preview-img" src="" alt="preview" style="max-width:120px; max-height:500px; border:1px solid #ccc;">
            </div>
        </div>

        <hr>  <!-- This line separates the input field from the buttons -->
        <!-- call submitNode() without referencing a non-existing node-shape element -->
        <button onclick="submitNode()">Add</button>
        <button onclick="closeNodeDialog()">Cancel</button>        
        <button onclick="saveCustomGraph()">Save Custom Graph</button>
        <button onclick="showCustomGraphName()">Show graph name</button>
        <button onclick="testAdd()">Test Add</button>
    </div>

    <!-- Image picker dialog: choose existing uploads or open uploader -->
    <div id="image-picker-dialog" class="floating-dialog" style="display:none; width:560px; max-width:95vw;">
      <div class="dialog-header">
        <span>Choose Image</span>
        <button onclick="closeImagePickerDialog()">X</button>
      </div>

      <div style="padding:8px;">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="image-filter" placeholder="Filter by name..." style="flex:1;" oninput="loadImageList()">
          <button id="refresh-images" onclick="loadImageList()">Refresh</button>
          <button onclick="openUploaderWindow()">Upload new</button>
        </div>

        <div id="image-list" style="max-height:320px; overflow:auto; display:grid; gap:8px;"></div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button onclick="closeImagePickerDialog()">Close</button>
        </div>
      </div>
    </div>

    <!-- Floating Edge Dialog -->
    <div id="floating-edge-dialog" class="floating-dialog">
        <div class="dialog-header" id="dialog-header">Select Edge Type</div>
        <select id="edge-type-selector"></select>
        <input type="text" id="new-edge-type-input" placeholder="Enter new edge type" style="display: none;" onblur="saveNewEdgeType(this)">
        <input type="text" id="edge-name" placeholder="Enter edge name">
        <hr>  <!-- This line separates the input field from the buttons -->
        <button onclick="submitEdge()">Add</button>
        <button onclick="closeEdgeDialog()">Cancel</button>
    </div>        

    <div id="create-node-type-dialog" class="floating-dialog" style="display: none;">
        <div class="dialog-header">
            <span>Create Node Type</span>
            <button onclick="closeCreateNodeTypeDialog()">X</button>
        </div>
        <input type="text" id="node-type-name" placeholder="Enter node type name" required>
        <!-- <input type="text" id="node-type-shape" placeholder="Enter shape (e.g., ellipse, box)" value="ellipse"> -->
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="node-shape">Node Shape:</label>
            <select id="node-type-shape" style="width: 70%;">
                <option value="box">Box</option>
                <option value="circle">Circle</option>
                <option value="circularImage">Circular Image</option>
                <option value="database">Database</option>
                <option value="diamond">Diamond</option>
                <option value="dot">Dot</option>
                <option value="ellipse" selected>Ellipse</option>
                <option value="hexagon">Hexagon</option>
                <option value="icon">Icon</option>
                <option value="image">Image</option>
                <option value="text">Text</option>
                <option value="triangle">Triangle</option>
                <option value="triangleDown">Triangle Down</option>
            </select>
        </div>

        <input type="color" id="node-type-color" value="#000000">
        <input type="number" id="node-type-size" placeholder="Enter size" value="25">

        <!-- Section for adding properties -->
        <div id="node-type-properties">
            <h4>Properties</h4>
            <div id="node-type-properties-content">
                <!-- Dynamically added properties will appear here -->
            </div>
            <button onclick="addNewNodeTypePropertyField()">Add Property</button>
        </div>

        <button onclick="submitNodeType()">Create</button>
    </div>    

    <!-- Context Menu for Nodes -->
    <div id="node-context-menu" class="context-menu">
        <ul>
            <li onclick="openHtml()">Edit html for user</li>
            <li onclick="openHtml_v4()">Edit html for user old version</li>
            <li onclick="openHtml_jsEditor()">Edit html for power user</li>
            <li onclick="openHtml_browser()">Open with browser</li>
            <li onclick="collapseNode()">Collapse</li>
            <li onclick="clearNode()">Clear node</li>
            <li onclick="removeNodeCustomGraph()">Remove node from custom graph</li>
        </ul>
    </div>

    <!-- Choose Edges Dialog -->
    <div id="choose-edges-dialog" class="floating-dialog">
        <div class="dialog-header">
            <span>Choose Edge Types</span>
            <button onclick="closeChooseEdgesDialog()">X</button>
        </div>
        <select id="choose-edges-selector" multiple style="width: 100%;"></select>
        <button onclick="saveEdgeChoices()">Save</button>
    </div>

    <div id="node-properties-dialog" class="floating-dialog" style="display: none;">
        <div class="dialog-header">
            <span>Node Properties</span>
            <button onclick="closeNodePropertiesDialog()">X</button>
        </div>
        <div id="node-properties-content">
            <!-- Node properties will be dynamically inserted here -->
        </div>
        <button onclick="addNewPropertyField()">Add Property</button>
        <button onclick="saveNodeProperties()">Save</button>
    </div>

    <!-- Choose Existing Nodes Dialog -->
    <div id="existing-nodes-dialog" class="floating-dialog" style="display: none;">
        <div class="dialog-header">
            <span>Add Existing Nodes</span>
            <button onclick="closeExistingNodesDialog()">X</button>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; width:320px;">
            <label for="existing-node-type-selector">Select Node Type:</label>
            <select id="existing-node-type-selector" style="width:100%;" onchange="onExistingNodeTypeChange(this.value)"></select>

            <div>
                <label>Existing Nodes (click to add):</label>
                <div id="existing-nodes-list" style="max-height:260px; overflow:auto; border:1px solid #ccc; padding:6px;"></div>
            </div>

            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button onclick="closeExistingNodesDialog()">Close</button>
            </div>
        </div>
    </div>

<!-- HTML Editor (CodeMirror) Dialog -->
<div id="html-editor-dialog" class="floating-dialog" style="display:none; width: 820px; max-width: 95vw;">
    <div class="dialog-header">
      <span id="html-editor-title">HTML Editor</span>
      <button onclick="closeHtmlEditorDialog()">X</button>
    </div>
  
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
      <button onclick="saveHtmlFromEditor()">Save</button>
      <button onclick="openAiSnippetDialog()">Ask AI</button>
      <button onclick="previewEditorHtml()">Preview</button>
      <button onclick="openChooseTemplateDialog()">Load template</button>
      
      <span id="html-editor-status" style="margin-left:auto; font-size:12px; opacity:.8;"></span>
    </div>
  
    <textarea id="html-editor-textarea" style="display:none;"></textarea>
    <div id="html-editor-container" style="border:1px solid #ddd;"></div>
  
    <div id="html-editor-preview" style="display:none; margin-top:8px; border:1px solid #eee; height:260px;">
      <iframe id="html-preview-iframe" title="Preview" style="width:100%; height:100%;" sandbox="allow-same-origin allow-scripts"></iframe>
    </div>
</div>

<!-- AI Snippet Dialog -->
<div id="ai-snippet-dialog" class="floating-dialog" style="display:none; width:600px; max-width:95vw;">
    <div class="dialog-header">
      <span>Ask AI for HTML snippet</span>
      <button onclick="closeAiSnippetDialog()">X</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <input id="ai-prompt" type="text" placeholder="Describe the snippet you want (e.g., responsive card with image and button)" style="flex:1;">
      <button onclick="askAiForSnippet()">Generate</button>
    </div>
    <textarea id="ai-snippet-output" style="width:100%; height:240px; font-family:monospace;"></textarea>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button onclick="insertAiSnippetIntoEditor()">Insert into editor</button>
      <button onclick="copyAiSnippet()">Copy</button>
    </div>
</div>

<!-- Include the choose-template dialog -->
{% include 'choose_template_dialog.html' %}

<script>
if (typeof window.createCM6HtmlEditor !== 'function') {
  window.createCM6HtmlEditor = function(parent, initialValue = "", {dark = true} = {}) {
    const ta = document.createElement('textarea');
    ta.style.width = '100%';
    ta.style.height = '100%';
    ta.value = initialValue || '';
    parent.appendChild(ta);
    const adapter = {
      getValue: () => ta.value,
      setValue: v => { ta.value = v; },
      getDoc: () => ({ getValue: () => ta.value, setValue: v => { ta.value = v; }, listSelections: () => [], replaceRange: () => {} }),
      focus: () => ta.focus()
    };
    return { view: null, adapter };
  };
  console.log('createCM6HtmlEditor: fallback textarea adapter installed');
}
</script>

<script>
    function resizeDialog() {
        const dialog = document.getElementById('cypher-dialog');
        const textarea = document.getElementById('cypher-input');
        dialog.style.height = textarea.scrollHeight + 'px';
    }
</script>

<script>
/* Resize helper for the HTML editor dialog so both the editor container / textarea
   and the preview iframe get adjusted when the dialog is resized.
*/
function resizeHtmlEditorComponents() {
  const dlg = document.getElementById('html-editor-dialog');
  if (!dlg) return;

  // allow the dialog to expand up to viewport minus margin
  const viewportMargin = 80; // px top+bottom margin
  const maxDlgH = Math.max(200, window.innerHeight - viewportMargin);
  dlg.style.maxHeight = maxDlgH + 'px';
  dlg.style.overflow = 'auto';

  const header = dlg.querySelector('.dialog-header');
  // toolbar is the element directly after header in your markup
  const toolbar = header ? header.nextElementSibling : null;

  const textarea = document.getElementById('html-editor-textarea');
  const container = document.getElementById('html-editor-container');
  const previewWrap = document.getElementById('html-editor-preview');
  const iframe = document.getElementById('html-preview-iframe');

  const dlgPad = 24; // padding/margins inside dialog
  const usedHeight = (header ? header.offsetHeight : 0) + (toolbar ? toolbar.offsetHeight : 0) + dlgPad;

  // available height inside dialog for editor/preview
  const available = Math.max(80, Math.min(maxDlgH, dlg.clientHeight) - usedHeight);

  // compute editorHeight based on presence of preview
  let editorHeight;
  if (previewWrap && previewWrap.style.display !== 'none') {
    const previewHeight = Math.min(available * 0.45, previewWrap.offsetHeight || 260);
    editorHeight = Math.max(80, available - previewHeight - 8);
    if (previewWrap) {
      previewWrap.style.maxHeight = Math.max(120, previewHeight) + 'px';
      previewWrap.style.overflow = 'auto';
    }
  } else {
    editorHeight = Math.max(120, available);
  }

  // apply sizes and ensure scroll/overflow
  if (container) {
    container.style.height = editorHeight + 'px';
    container.style.maxHeight = editorHeight + 'px';
    container.style.overflow = 'auto';
  }
  if (textarea && textarea.style.display !== 'none') {
    textarea.style.height = editorHeight + 'px';
    textarea.style.maxHeight = editorHeight + 'px';
  }
  if (iframe && previewWrap) {
    iframe.style.height = (previewWrap.clientHeight || 0) + 'px';
  }

  // refresh editors so they adapt to new sizes
  try {
    // CM5 instance (adapter stored as cmEditor.view earlier)
    if (typeof cmEditor !== 'undefined' && cmEditor && cmEditor.view) {
      try { cmEditor.view.setSize && cmEditor.view.setSize(null, editorHeight); } catch(e){}
      try { cmEditor.view.refresh && cmEditor.view.refresh(); } catch(e){}
    }

    // CM6 view (if you kept reference as cm6View or _htmlEditorInstance.view)
    const cm6 = window.cm6View || (window._htmlEditorInstance && window._htmlEditorInstance.view) || window._htmlEditorInstance;
    if (cm6) {
      try { cm6.requestMeasure && cm6.requestMeasure(); } catch(e){}
      try { cm6.update && cm6.update(); } catch(e){}
      try { cm6.refresh && cm6.refresh(); } catch(e){}
    }

    // generic fallback refresh hooks
    if (window._cm && typeof window._cm.refresh === 'function') window._cm.refresh();
  } catch (e) {
    console.warn('resizeHtmlEditorComponents refresh error', e);
  }
}

// Keep editor layout updated on window resize
window.addEventListener('resize', resizeHtmlEditorComponents);

// Call the resize helper after opening the html editor; add a global convenience function
window.showHtmlEditorDialog = function() {
  const dlg = document.getElementById('html-editor-dialog');
  if (!dlg) return;
  // set a large height so resizeHtmlEditorComponents can compute available space
  dlg.style.display = 'block';
  // force dialog to use a viewport based height limit immediately
  dlg.style.maxHeight = Math.max(300, window.innerHeight - 80) + 'px';
  // small timeout to allow CSS/layout to settle before computing sizes
  setTimeout(resizeHtmlEditorComponents, 60);
};
</script>

<script>
      // expose helper to open image picker from node dialog
      function openImagePickerDialog() {
        const dlg = document.getElementById('image-picker-dialog');
        if (!dlg) return;
        dlg.style.display = 'block';
        // reset filter and load images
        const f = document.getElementById('image-filter');
        if (f) f.value = '';
        loadImageList();
      }
      function closeImagePickerDialog() {
        const dlg = document.getElementById('image-picker-dialog');
        if (!dlg) return;
        dlg.style.display = 'none';
      }

      async function loadImageList() {
        const listEl = document.getElementById('image-list');
        const filter = (document.getElementById('image-filter') || {}).value || '';
        listEl.innerHTML = '<div style="padding:12px;color:#777">Loading…</div>';
        try {
          const res = await fetch('/uploader/files');
          if (!res.ok) throw new Error('Failed to list images');
          const items = await res.json();
          // show only image extensions
          const images = (items || []).filter(it => /\.(png|jpe?g|gif|webp|svg)$/i.test(it.name));
          const filtered = images.filter(it => it.name.toLowerCase().includes(filter.toLowerCase()));
          if (filtered.length === 0) {
            listEl.innerHTML = '<div style="padding:12px;color:#777">No images found.</div>';
            return;
          }
          listEl.innerHTML = '';
          filtered.forEach(it => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.gap = '8px';
            row.style.padding = '6px';
            row.style.borderBottom = '1px solid #eee';

            const thumb = document.createElement('img');
            thumb.alt = it.name;
            thumb.style.width = '72px';
            thumb.style.height = '54px';
            thumb.style.objectFit = 'cover';
            // Try static path first, fallback to download endpoint on error
            thumb.src = `/static/images/${encodeURIComponent(it.name)}`;
            thumb.onerror = function() {
              this.onerror = null;
              this.src = `/uploader/download/${encodeURIComponent(it.name)}`;
            };

            const info = document.createElement('div');
            info.style.flex = '1';
            info.innerHTML = `<div style="font-size:13px;">${it.name}</div><div style="font-size:12px;color:#666">${(it.size/1024).toFixed(1)} KB</div>`;

            const chooseBtn = document.createElement('button');
            chooseBtn.textContent = 'Choose';
            chooseBtn.onclick = function() {
              selectImageForNode(it.name);
              closeImagePickerDialog();
            };

            row.appendChild(thumb);
            row.appendChild(info);
            row.appendChild(chooseBtn);
            listEl.appendChild(row);
          });
        } catch (err) {
          listEl.innerHTML = `<div style="padding:12px;color:#c00">Failed to load images: ${err.message}</div>`;
        }
      }

      function openUploaderWindow() {
        // Open your existing uploader UI in a new tab/window so user can upload.
        // After upload user can close it and click Refresh in the picker.
        window.open('/uploader', '_blank', 'noopener,noreferrer,width=900,height=700');
      }

      // When an image is selected, populate node-image-url and preview
      function selectImageForNode(filename) {
        const urlStatic = `/static/images/${encodeURIComponent(filename)}`;
        const urlDownload = `/uploader/download/${encodeURIComponent(filename)}`;
        const input = document.getElementById('node-image-url');
        const previewWrap = document.getElementById('node-image-preview');
        const previewImg = document.getElementById('node-image-preview-img');
        if (!input) return;
        // prefer static url; preview will handle fallback
        input.value = urlStatic;
        if (previewWrap && previewImg) {
          previewImg.src = urlStatic;
          previewImg.onerror = function() {
            this.onerror = null;
            this.src = urlDownload;
          };
          previewWrap.style.display = 'block';
        }
      }

      // wire a small convenience button into the existing node dialog
      (function injectNodeDialogButtons(){
        const nodeField = document.getElementById('node-image-field');
        if (!nodeField) return;
        const actions = document.createElement('div');
        actions.style.marginTop = '8px';
        actions.innerHTML = `<button type="button" onclick="openImagePickerDialog()">Choose existing image</button>
                             <button type="button" onclick="openUploaderWindow()" style="margin-left:8px;">Upload image</button>`;
        nodeField.appendChild(actions);
      })();
    </script>

<script src="{{ url_for('static', filename='indexScript.js') }}"></script>
</body>
</html>
